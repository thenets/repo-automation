---
# Test workflow for the new triage action
# This workflow tests our new composite action implementation

name: "Test: Triage Action"

on:
  # Test on new issues
  issues:
    types: [opened]

  # Test on pull request events
  pull_request:
    types: [opened, synchronize, ready_for_review]

  # Manual trigger for testing
  workflow_dispatch:
    inputs:
      dry_run:
        description: 'Run in dry-run mode'
        required: false
        default: 'true'
        type: boolean
      test_feature:
        description: 'Test specific feature set (basic, stale, release, feature-branch, complete)'
        required: false
        default: 'complete'
        type: choice
        options:
          - basic
          - stale
          - release
          - feature-branch
          - complete

permissions:
  issues: write
  pull-requests: write

jobs:
  test-triage-action:
    runs-on: ubuntu-latest

    # Only run on this repository for testing
    if: github.repository == 'thenets/repo-automation'

    steps:
      - name: Checkout repository
        uses: actions/checkout@v4

      - name: Test Triage Action
        id: triage
        uses: ./
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          custom-github-token: ${{ secrets.CUSTOM_GITHUB_TOKEN }}
          dry-run: ${{ github.event.inputs.dry_run || 'false' }}
          
          # Feature configurations based on test selection
          stale-days: ${{ (github.event.inputs.test_feature == 'stale' || github.event.inputs.test_feature == 'complete') && '1' || '' }}
          accepted-releases: ${{ (github.event.inputs.test_feature == 'release' || github.event.inputs.test_feature == 'complete') && '["1.0", "2.0", "devel"]' || '' }}
          accepted-backports: ${{ (github.event.inputs.test_feature == 'release' || github.event.inputs.test_feature == 'complete') && '["1.0", "2.0"]' || '' }}
          enable-feature-branch: ${{ (github.event.inputs.test_feature == 'feature-branch' || github.event.inputs.test_feature == 'complete') && 'true' || 'false' }}

      - name: Display Results
        if: always()
        run: |
          {
            echo "## 🧪 Triage Action Test Results"
            echo ""
            echo "**Test Mode:** \`${{ github.event.inputs.test_feature || 'auto-trigger' }}\`"
            if [ "${{ github.event.inputs.dry_run }}" == "true" ]; then
              echo "**Dry Run:** ✅ Enabled (no actual changes made)"
            else
              echo "**Dry Run:** ❌ Disabled (real changes made)"
            fi
            echo ""
            echo "**Features Enabled:** ${{ steps.triage.outputs.features-enabled }}"
            echo ""
            echo "**Labels Added:** \`${{ steps.triage.outputs.labels-added }}\`"
            echo ""
            echo "**Actions Taken:**"
            echo "${{ steps.triage.outputs.actions-taken }}"
            echo ""
            echo "**Event Details:**"
            echo "- Event: \`${{ github.event_name }}\`"
            if [ "${{ github.event.action }}" != "" ]; then
              echo "- Action: \`${{ github.event.action }}\`"
            fi
            echo ""
            echo "_Testing the unified GitHub Action that replaced 4 individual keeper workflows._"
          } >> "$GITHUB_STEP_SUMMARY"

          # Also log to console for debugging
          echo "🧪 Triage Action Test completed:"
          echo "  Test mode: ${{ github.event.inputs.test_feature || 'auto-trigger' }}"
          echo "  Dry run: ${{ github.event.inputs.dry_run || 'false' }}"
          echo "  Features: ${{ steps.triage.outputs.features-enabled }}"
          echo "  Labels added: ${{ steps.triage.outputs.labels-added }}"
          echo "  Actions taken: ${{ steps.triage.outputs.actions-taken }}"
          echo "  Event: ${{ github.event_name }}/${{ github.event.action }}"
